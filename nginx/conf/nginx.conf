
#user  nobody;
worker_processes  1;

error_log  logs/error.log;
error_log  logs/error.log  notice;
error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}


http {
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        fastcgi_buffer_size 16k;
        fastcgi_buffers 16 16k;

	include       mime.types;
	default_type  application/octet-stream;

	#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
	#                  '$status $body_bytes_sent "$http_referer" '
	#                  '"$http_user_agent" "$http_x_forwarded_for"';

	#access_log  logs/access.log  main;

	sendfile        on;
	#tcp_nopush     on;

	#keepalive_timeout  0;
	keepalive_timeout  65;

	#gzip  on;

	geo $dollar { 
		default "$"; 
	}

        header_filter_by_lua_file conf/mpt_header_script.lua;

	#
	# HTTP server
	#
	server {
		listen       80;
		server_name  localhost;
		root .;

		#charset koi8-r;
		#access_log  logs/host.access.log  main;

                # Include Marktplaatstabel authentication subfilter rules
                include mpt_auth.conf;

		# Proxy http://www.marktplaats.nl through http://localhost 
		location / {
			proxy_pass http://www.marktplaats.nl;
			proxy_set_header Accept-Encoding "";
                        # Include Marktplaatstabel Nginx subfilter rules
                        include mpt_sub_filter.conf;
		}

		location /marktplaatstabel {
			index  index.php;
		}

		location '/Marktplaats-tabel' {
			alias C:\Users\Public\Documents\Marktplaats-tabel;
		}

		location ~ ^/(.*).ico$ {
			alias images/$1.ico;
		}

		# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
		#
		location ~* ^/marktplaatstabel(/|.*\.php)$ {
			fastcgi_pass   127.0.0.1:9123;
			fastcgi_index  index.php;
			fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
			include        fastcgi_params;
		}

		#error_page  404              /404.html;

		# redirect server error pages to the static page /50x.html
		#
		error_page   500 502 503 504  /50x.html;
		location = /50x.html {
		#root   html;
		}

		# deny access to .htaccess files, if Apache's document root
		# concurs with nginx's one
		#
		#location ~ /\.ht {
		#    deny  all;
		#}
	}


	#
	# HTTPS server
	#
	server {
		listen       443 ssl;
		server_name  localhost;
		root .;

		ssl_certificate      server.crt;
		ssl_certificate_key  server.key;

		#ssl_session_cache    shared:SSL:1m;
		ssl_session_timeout  5m;

		ssl_ciphers  HIGH:!aNULL:!MD5;
		ssl_prefer_server_ciphers  on;

                # Include Marktplaatstabel authentication subfilter rules
                include mpt_auth.conf;

		# Proxy https://www.marktplaats.nl through https://localhost 
		location / {
			proxy_pass https://www.marktplaats.nl;

                        # Default $proxy_host for HTTPS not working?
			proxy_set_header Host "www.marktplaats.nl";
			proxy_set_header Accept-Encoding "";

                        # Include Marktplaatstabel Nginx subfilter rules
                        include mpt_sub_filter.conf;

			# Insert new css file
			subs_filter '</head>' '<link href="https://localhost/marktplaatstabel/css/marktplaats800px.css" rel="stylesheet" type="text/css" media="screen"></link></head>' ir;

			# Insert expandSelect javascript addon
			subs_filter '</body>' '<script type="text/javascript" src="https://localhost/marktplaatstabel/js/expandSelect.js"></script></head>' ir;

			# Open 'place add' form target in new window to prevent HTTP iframe in HTTPS document.
			subs_filter '(action="https://localhost/syi/plaatsAdvertentie.html/save.html")' '$1 target="_blank"' ir;
		}

		location /marktplaatstabel {
			index  index.php;
		}

		location ~ ^/(.*).ico$ {
			alias images/$1.ico;
		}

                # Prevent redirect after ajax submit form with lua
                location /ajaxPlaatsAdvertentie.html {
                    proxy_pass https://www.marktplaats.nl/syi/plaatsAdvertentie.html/save.html;
                    # error_page 302 = 200; not allowed?
                    header_filter_by_lua_file conf/mpt_header_script_plaats_advertentie.lua;
                }

		# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
		#
		location ~* ^/marktplaatstabel(/|.*\.php)$ {
			fastcgi_pass   127.0.0.1:9123;
			fastcgi_index  index.php;
			fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
			include        fastcgi_params;
		}

	}
}
