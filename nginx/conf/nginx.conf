
#user  nobody;
worker_processes  1;

error_log  logs/error.log;
error_log  logs/error.log  notice;
error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}


http {
	include       mime.types;
	default_type  application/octet-stream;

	#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
	#                  '$status $body_bytes_sent "$http_referer" '
	#                  '"$http_user_agent" "$http_x_forwarded_for"';

	#access_log  logs/access.log  main;

	sendfile        on;
	#tcp_nopush     on;

	#keepalive_timeout  0;
	keepalive_timeout  65;

	#gzip  on;

	geo $dollar { 
		default "$"; 
	}

	# Remove domain attribute and value from all cookies.
	# RFC 6265: If the server omits the Domain attribute, the user agent will return the cookie only to the origin server.
	# Accept cookies on marktplaats.nl (Art. 11.7a Tw)
	header_filter_by_lua '
		local cookies = ngx.header.set_cookie 
		if not cookies then return end
		if type(cookies) ~= "table" then cookies = {cookies} end
		local newCookies = {}
		for i, cookie in ipairs(cookies) do
                        if string.find(cookie, "MpSecurity") then 
                            local loggedInCookie = "LoggedIn=false; Path=/;"
                            local from, to, err = ngx.re.find(cookie, "MpSecurity=[A-z0-9]{84}.*", "jo")
                            if from then
                                loggedInCookie = "LoggedIn=true; Path=/;"
                            end
                            table.insert(newCookies, loggedInCookie) 
                        end
			local newCookie = string.gsub(cookie, "([dD]omain)=[%w_-\\\\.]+;?", "")
			table.insert(newCookies, newCookie) 
		end 
		local expires = 365*24*60*60
		local newCookie = "CookieOptIn=true; Path=/; Expires=" .. ngx.cookie_time(ngx.time() + expires)
		table.insert(newCookies, newCookie) 
		ngx.header.set_cookie = newCookies 

		local location = ngx.header.location;
		if location then
			local newlocation = ngx.re.gsub(location, "http(s)?://www.marktplaats.nl", "http$1://localhost")
			ngx.header.location = newlocation;
		end
	'; 

	#
	# HTTP server
	#
	server {
		listen       80;
		server_name  localhost;
		root .;

		#charset koi8-r;
		#access_log  logs/host.access.log  main;

                include nginx.auth.conf;

		# Proxy http://www.marktplaats.nl through http://localhost 
		location / {
			proxy_pass http://www.marktplaats.nl;

			proxy_set_header Accept-Encoding "";

                        # s.marktplaats.com gzip
                        subs_filter '//(s.marktplaats.com/jawr/)(.*)' '//$1gzip_$2' ir;

       			# Filter html, javascript and json
			subs_filter_types text/javascript application/json;

			# Replace marktplaats.nl links with localhost (except values of hidden input elements)
			subs_filter '(?<!value=")http(s)?://www.marktplaats.nl' 'http$1://localhost' ir;

                        # Proxy auth.marktplaats.nl through localhost to filter
                        # cookies by header_filter_by_lua.
                        subs_filter '//(auth.marktplaats.nl)' '//localhost/$1' ir;

			# Disable analytics. Marktplaatstabel is not a real user.
			subs_filter '\(window, document, \'script\', \'dataLayer\', \'GTM-TFG7LW\'\)' '' ir;
			subs_filter '<script.*tealeaf.js" ></script>' '' ir;
			subs_filter '<script.*SpeedStatsCollector.js" ></script>' '' ir;
			subs_filter '//www.googletagmanager.com/ns.html\?id=GTM-TFG7LW' '' ir;
			subs_filter '(function sitespeedHandler\(\) {)' '$1 return;' ir;

			sub_filter_once off;
		}

		location /marktplaatstabel {
			index  index.php;
		}

		location '/Marktplaats-tabel' {
			alias C:\Users\Public\Documents\Marktplaats-tabel;
		}

		location ~ ^/(.*).ico$ {
			alias images/$1.ico;
		}

		# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
		#
		location ~* ^/marktplaatstabel(/|.*\.php)$ {
			fastcgi_pass   127.0.0.1:9123;
			fastcgi_index  index.php;
			fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
			include        fastcgi_params;
		}

		#error_page  404              /404.html;

		# redirect server error pages to the static page /50x.html
		#
		error_page   500 502 503 504  /50x.html;
		location = /50x.html {
		#root   html;
		}

		# deny access to .htaccess files, if Apache's document root
		# concurs with nginx's one
		#
		#location ~ /\.ht {
		#    deny  all;
		#}
	}


	#
	# HTTPS server
	#
	server {
		listen       443 ssl;
		server_name  localhost;
		root .;

		ssl_certificate      server.crt;
		ssl_certificate_key  server.key;

		#ssl_session_cache    shared:SSL:1m;
		ssl_session_timeout  5m;

		ssl_ciphers  HIGH:!aNULL:!MD5;
		ssl_prefer_server_ciphers  on;

                include nginx.auth.conf;

		# Proxy https://www.marktplaats.nl through https://localhost 
		location / {
			proxy_pass https://www.marktplaats.nl;

                        # Default $proxy_host for HTTPS not working?
			proxy_set_header Host "www.marktplaats.nl";
			proxy_set_header Accept-Encoding "";

                        # s.marktplaats.com gzip
                        subs_filter '//(s.marktplaats.com/jawr/)(.*)' '//$1gzip_$2' ir;

                        # Filter html, javascript and json
			subs_filter_types text/javascript application/json;

			# Replace marktplaats.nl links with localhost (except values of hidden input elements)
			subs_filter '(?<!value=")http(s)?://www.marktplaats.nl' 'http$1://localhost' ir;

                        # Proxy auth.marktplaats.nl through localhost to filter
                        # cookies by header_filter_by_lua.
                        subs_filter '//(auth.marktplaats.nl)' '//localhost/$1' ir;

			# Disable analytics. Marktplaatstabel is not a real user.
			subs_filter '\(window, document, \'script\', \'dataLayer\', \'GTM-TFG7LW\'\)' '' ir;
			subs_filter '<script.*tealeaf.js" ></script>' '' ir;
			subs_filter '<script.*SpeedStatsCollector.js" ></script>' '' ir;
			subs_filter '//www.googletagmanager.com/ns.html\?id=GTM-TFG7LW' '' ir;
			subs_filter '(function sitespeedHandler\(\) {)' '$1 return;' ir;

			# Insert new css file
			subs_filter '</head>' '<link href="https://localhost/marktplaatstabel/css/marktplaats800px.css" rel="stylesheet" type="text/css" media="screen"></link></head>' ir;

			# Insert expandSelect javascript addon
			subs_filter '</body>' '<script type="text/javascript" src="https://localhost/marktplaatstabel/js/expandSelect.js"></script></head>' ir;

			# Open 'place add' form target in new window to prevent HTTP iframe in HTTPS document.
			subs_filter '(action="https://localhost/syi/plaatsAdvertentie.html/save.html")' '$1 target="_blank"' ir;

			sub_filter_once off;
		}

		location /marktplaatstabel {
			index  index.php;
		}

		location ~ ^/(.*).ico$ {
			alias images/$1.ico;
		}

		# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
		#
		location ~* ^/marktplaatstabel(/|.*\.php)$ {
			fastcgi_pass   127.0.0.1:9123;
			fastcgi_index  index.php;
			fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
			include        fastcgi_params;
		}

	}
}
